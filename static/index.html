<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8 />
    <title>OpenIS</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
    <script src="scripts/wellknown.js" type="text/javascript"></script> 
    <script type="text/javascript" src='scripts/easy-button.js'></script>
    <script type="text/stylesheet" src="css/easy-button.css"></script>
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">

    <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
    <script type="text/javascript" src="scripts/sparql.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:fixed; top:0%; bottom:0; width:100%;}
        .sparql-template {display: none;}
  </style>
</head>
<body>
    <div id='map'></div>

    <script type="text/javascript">
    $(document).ready(function(){
        var mapboxTiles = L.tileLayer('https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw' , {
            attribution: '© <a href="https://www.mapbox.com/map-feedback/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });

        var map = L.map('map')
                   .addLayer(mapboxTiles)
                   .setView([50.83906, 4.35308], 13);
        tracks = new L.FeatureGroup();
        map.addLayer(tracks);

        function showIntersectingTracks(track){
            map.removeLayer(tracks);
            tracks = new L.FeatureGroup();
            map.addLayer(tracks);
            var template = SPARQL.loadTemplate('getTracksCrossing');

            SPARQL.query(template({track: track}))
                  .done(showTracks)
                  .fail(function(){alert("Error while querying!");});
        }

        function showTracks(data){
            console.log(data);

            var res = data.results.bindings
            tracks = new L.FeatureGroup();
            map.addLayer(tracks);
            for (var i=0; i<res.length; i++){
                var col = '#' + (function co(lor){   return (lor +=
                  [0,1,2,3,4,5,6,7,8,9,'a','b','c','d','e','f'][Math.floor(Math.random()*16)])
                  && (lor.length == 6) ?  lor : co(lor); })(''); 
                var track = L.geoJson(parse(res[i].geom.value),{color: col});
                var trackValue = res[i].track.value;
                var newDom = $("<span> <pre>" + trackValue + "</pre></span>");
                newDom.append($("<button data-track=\"" + trackValue + "\" type=\"button\">Show intersecting tracks</button>").click(function(){
                    console.log(this);
                    showIntersectingTracks($(this).attr('data-track'));
                }))
                track.bindPopup(newDom[0]);
                track.addTo(tracks);
            }
        }
        function showSpots(data){
            var res = data.results.bindings
            tracks = new L.FeatureGroup();
            map.addLayer(tracks);
            for (var i=0; i<res.length; i++){
                var spot = L.geoJson(parse(res[i].geom.value));
                console.log(res[i]);
                var trackValue = res[i].exercise_spot.value;
                spot.bindPopup("<pre>" + trackValue + "</pre>");
                spot.addTo(tracks);
            }

        }
        function deleteTracks(){
            map.removeLayer(tracks);
        }

        L.easyButton({states:[
            {
                stateName: 'addTracks',
                icon: '<span class="star">&starf;</span>',
                onClick: function(control){
                    var box = map.getBounds();
                    var template = SPARQL.loadTemplate('getAllTracks');
                    var args = {
                        lon1: box._northEast.lng,
                        lat1: box._northEast.lat,
                        lon2: box._southWest.lng,
                        lat2: box._southWest.lat
                    };

                    SPARQL.query(template(args))
                          .done(showTracks)
                          .fail(function(){alert("Error while querying!");});
                    control.state('removeTracks');
                },
                title: 'Display all tracks'
            },
            {
                stateName: 'removeTracks',
                icon: '<span class="cross">&cross;</span>',
                onClick: function(control){
                    deleteTracks();
                    control.state('addTracks');
                },
                title: 'Hide all tracks'
            }
        ]}).addTo(map);

        L.easyButton({states:[
            {
                stateName: 'addBikeTracks',
                icon: 'fa-bicycle',
                onClick: function(control){
                    var template = SPARQL.loadTemplate('getBikingTracks');

                    SPARQL.query(template())
                          .done(showTracks)
                          .fail(function(){alert("Error while querying!");});
                    control.state('removeBikeTracks');
                },
                title: 'Display all bike tracks'
            },
            {
                stateName: 'removeBikeTracks',
                icon: '<span class="cross">&cross;</span>',
                onClick: function(control){
                    deleteTracks();
                    control.state('addBikeTracks');
                },
                title: 'Hide all bike tracks'
            }
        ]}).addTo(map);

        L.easyButton({states:[
            {
                stateName: 'addAllSpots',
                icon: 'fa-map-marker',
                onClick: function(control){
                    var template = SPARQL.loadTemplate('getAllSpots');

                    SPARQL.query(template())
                          .done(showSpots)
                          .fail(function(){alert("Error while querying!");});
                    control.state('removeAllSpots');
                },
                title: 'Display all Exercise Spots'
            },
            {
                stateName: 'removeAllSpots',
                icon: '<span class="cross">&cross;</span>',
                onClick: function(control){
                    deleteTracks();
                    control.state('addAllSpots');
                },
                title: 'Hide all Exercise Spots'
            }
        ]}).addTo(map);

    });
    </script>

    <div class="sparql-template" id="getAllTracks">
        SELECT DISTINCT ?track ?geom
        WHERE {
            ?track rdf:type tr:Track.
            ?track geo:hasGeometry ?geom.
        }
    </div>
    <div class="sparql-template" id="getTracksInBox">
        SELECT DISTINCT ?track ?geom
        WHERE {
          ?track rdf:type tr:Track.
          ?track geo:hasGeometry ?geom.
          FILTER (
            geof:sfContains(
              STRDT("POLYGON((${lon1} ${lat1}, ${lon1} ${lat2}, ${lon2} ${lat2}, ${lon2} ${lat1}, ${lon1} ${lat1}))", sf:wktLiteral),
              STRDT(?geom, sf:wktLiteral)
            )
          ).
        }
    </div>
    <div class="sparql-template" id="getTracksCrossing">
        SELECT DISTINCT ?track ?geom
        WHERE {
          ?track rdf:type tr:Track.
          ?track geo:hasGeometry ?geom.
          <${track}> geo:hasGeometry ?x.
          FILTER (
            geof:sfIntersects(
              STRDT(?x, sf:wktLiteral),
              STRDT(?geom, sf:wktLiteral)
            )
          ).
        }
    </div>

    <div class="sparql-template" id="getAllSpots">
        SELECT DISTINCT ?exercise_spot ?geom
        WHERE {
            ?exercise_spot rdf:type ont:ExerciseSpot.
            ?track rdf:type ont:Track.
            ?exercise_spot ont:isAlongTrack ?track.
            ?exercise_spot geo:hasGeometry ?geom.
        }
    </div>

    <div class="sparql-template" id="getBikingTracks">
        SELECT DISTINCT ?track ?geom
        WHERE {
            ?ex rdf:type exont:Exercise.
            ?ex exont:HasType "Biking".
            ?ex ont:hasTrack ?track.
            ?track geo:hasGeometry ?geom.
        }
    </div>
</body>
</html>